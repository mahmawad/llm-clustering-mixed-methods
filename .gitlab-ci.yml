# LLM Clustering Mixed Methods CI/CD Pipeline
# Tests the topic modeling implementation with proper timeouts and validation

stages:
  - setup
  - test
  - analyze

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  paths:
    - .cache/pip
    - .venv/

before_script:
  - echo "Setting up Python environment..."
  - python3 -m venv .venv || true
  - source .venv/bin/activate
  - pip install --upgrade pip setuptools wheel
  - echo "Installing dependencies..."
  - pip install -r requirements.txt

# Stage 1: Setup and validate environment
setup-job:
  stage: setup
  script:
    - echo "✓ Python environment ready"
    - python3 --version
    - pip list | grep -E "pandas|bertopic|sentence-transformers|umap-learn|openai"
    - echo "✓ All required packages installed"
  timeout: 10 minutes

# Stage 2: Code quality and syntax checks
lint-test-job:
  stage: test
  script:
    - echo "Checking Python syntax..."
    - python3 -m py_compile csv_utils.py
    - python3 -m py_compile topic_modeling.py
    - python3 -m py_compile main.py
    - echo "✓ No syntax errors found"
  timeout: 5 minutes

# Stage 2: Validate data and imports
import-test-job:
  stage: test
  script:
    - echo "Testing module imports..."
    - python3 -c "import pandas; print('✓ pandas imported')"
    - python3 -c "import csv_utils; print('✓ csv_utils imported')"
    - python3 -c "import topic_modeling; print('✓ topic_modeling imported')"
    - echo "✓ All imports successful"
  timeout: 10 minutes

# Stage 3: Run full analysis pipeline
analyze-job:
  stage: analyze
  script:
    - echo "=========================================="
    - echo "Starting LLM Clustering Analysis Pipeline"
    - echo "=========================================="
    - python3 main.py
    - echo ""
    - echo "Validating output files..."
    - |
      if [ -f "out-2/documents_visualization.html" ]; then
        echo "✓ HTML visualization created"
        wc -l out-2/documents_visualization.html
      else
        echo "✗ ERROR: HTML visualization not created"
        exit 1
      fi
    - |
      if [ -f "out-2/document_topics.xlsx" ]; then
        echo "✓ Excel export created"
        ls -lh out-2/document_topics.xlsx
      else
        echo "✗ ERROR: Excel export not created"
        exit 1
      fi
    - echo ""
    - echo "=========================================="
    - echo "✓ Analysis pipeline completed successfully"
    - echo "=========================================="
  timeout: 2 hours
  artifacts:
    paths:
      - out-2/documents_visualization.html
      - out-2/document_topics.xlsx
    expire_in: 30 days
  allow_failure: false
